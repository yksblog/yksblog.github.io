<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cps变换</title>
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' href='https://yangk.net/org_themes/favicon.ico' type='image/x-icon' />
           <link rel='stylesheet' href='https://yangk.net/org_themes/style.css' type='text/css'  />
           <script type='module' src='https://yangk.net/org_themes/main.js' defer></script>
<meta name="card" content="">
</head>
<body>
<div id="content" class="content">
<h1 class="title">Cps变换</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org267cd5c">什么是CPS呢？</a>
<ul>
<li><a href="#org34036e2">例1:js版本</a>
<ul>
<li><a href="#orgda810fc">原味</a></li>
<li><a href="#org46d7c04">CPS</a></li>
</ul>
</li>
<li><a href="#orgb4cd169">例2:java版本</a>
<ul>
<li><a href="#org661759a">原味</a></li>
<li><a href="#org1f5b29f">CPS</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8cc7dd7">王垠的「40 行代码」</a></li>
<li><a href="#orgef3a38d">参考资料</a></li>
</ul>
</div>
</div>


<div id="outline-container-org267cd5c" class="outline-2">
<h2 id="org267cd5c">什么是CPS呢？</h2>
<div class="outline-text-2" id="text-org267cd5c">
<ul class="org-ul">
<li>Continuation-Passing Style, 有道翻译：连续传球风格编程，说的简单点，其实就是函数通过回调传递结果</li>
</ul>
</div>

<div id="outline-container-org34036e2" class="outline-3">
<h3 id="org34036e2">例1:js版本</h3>
<div class="outline-text-3" id="text-org34036e2">
</div>
<div id="outline-container-orgda810fc" class="outline-4">
<h4 id="orgda810fc">原味</h4>
<div class="outline-text-4" id="text-orgda810fc">
<div class="org-src-container">
<pre class="src src-js"><span style="color: #F92672;">function</span> <span style="color: #A6E22E;">foo</span><span style="color: #AE81FF;">(</span><span style="color: #FD971F;">x</span><span style="color: #AE81FF;">)</span> <span style="color: #AE81FF;">{</span>
    <span style="color: #F92672;">return</span> x ;
<span style="color: #AE81FF;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org46d7c04" class="outline-4">
<h4 id="org46d7c04">CPS</h4>
<div class="outline-text-4" id="text-org46d7c04">
<div class="org-src-container">
<pre class="src src-js"><span style="color: #F92672;">function</span> <span style="color: #A6E22E;">cps_foo</span><span style="color: #AE81FF;">(</span><span style="color: #FD971F;">x</span>, <span style="color: #FD971F;">return_point</span><span style="color: #AE81FF;">)</span> <span style="color: #AE81FF;">{</span>
    <span style="color: #F92672;">return</span> return_point <span style="color: #66D9EF;">(</span>x<span style="color: #66D9EF;">)</span> ;
<span style="color: #AE81FF;">}</span>
</pre>
</div>


<p>
CPS 多了一个参数 return_point，return_point 来自function的调用者 ，是调用者所在的context，调用者将这个context 传递给cps，这样cps 就无须利用额外的工具（比如堆栈）去查询调用者的环境在哪里(调用位置)，以便返回，而是直接进入这个环境：return_point (x)。
</p>

<p>
这便是 CPS 的初衷 —— 去掉层层嵌套的世界。行话讲就是 desugar（脱糖）。
</p>

<p>
Syntax sugar 是为了方便人类的表达和理解，给编程语言的核心套上的一层好吃好看的外衣，而对机器对程序的解释，需要将其还原到最本质的结构，以便机械化处理和优化，这 就是脱糖的意义。
</p>
</div>
</div>
</div>

<div id="outline-container-orgb4cd169" class="outline-3">
<h3 id="orgb4cd169">例2:java版本</h3>
<div class="outline-text-3" id="text-orgb4cd169">
</div>
<div id="outline-container-org661759a" class="outline-4">
<h4 id="org661759a">原味</h4>
<div class="outline-text-4" id="text-org661759a">
<div class="org-src-container">
<pre class="src src-java"><span style="color: #F92672;">public</span> <span style="color: #F92672;">class</span> <span style="color: #66D9EF;">Demo</span> <span style="color: #AE81FF;">{</span>
    <span style="color: #F92672;">public</span> <span style="color: #F92672;">static</span> <span style="color: #66D9EF;">long</span> <span style="color: #A6E22E;">plus</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">i1</span>, <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">i2</span><span style="color: #66D9EF;">)</span> <span style="color: #66D9EF;">{</span>
        <span style="color: #F92672;">return</span> i1 + i2;
    <span style="color: #66D9EF;">}</span>
    <span style="color: #F92672;">public</span> <span style="color: #F92672;">static</span> <span style="color: #66D9EF;">void</span> <span style="color: #A6E22E;">main</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">String</span><span style="color: #A6E22E;">[]</span> <span style="color: #FD971F;">args</span><span style="color: #66D9EF;">)</span> <span style="color: #66D9EF;">{</span>
        System.out.println<span style="color: #A6E22E;">(</span>plus<span style="color: #E6DB74;">(</span>1, 2<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span>;
    <span style="color: #66D9EF;">}</span>
<span style="color: #AE81FF;">}</span>


</pre>
</div>
</div>
</div>

<div id="outline-container-org1f5b29f" class="outline-4">
<h4 id="org1f5b29f">CPS</h4>
<div class="outline-text-4" id="text-org1f5b29f">
<div class="org-src-container">
<pre class="src src-java">
<span style="color: #F92672;">public</span> <span style="color: #F92672;">class</span> <span style="color: #66D9EF;">CpsDemo</span> <span style="color: #AE81FF;">{</span>

    <span style="color: #F92672;">interface</span> <span style="color: #66D9EF;">Continuation</span> <span style="color: #66D9EF;">{</span>
        <span style="color: #66D9EF;">void</span> <span style="color: #A6E22E;">next</span><span style="color: #A6E22E;">(</span><span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">result</span><span style="color: #A6E22E;">)</span>;
    <span style="color: #66D9EF;">}</span>

    <span style="color: #F92672;">public</span> <span style="color: #F92672;">static</span> <span style="color: #66D9EF;">void</span> <span style="color: #A6E22E;">plus</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">i1</span>, <span style="color: #66D9EF;">int</span> <span style="color: #FD971F;">i2</span>, <span style="color: #66D9EF;">Continuation</span> <span style="color: #FD971F;">continuation</span><span style="color: #66D9EF;">){</span>
        continuation.next<span style="color: #A6E22E;">(</span>i1 + i2<span style="color: #A6E22E;">)</span>;
    <span style="color: #66D9EF;">}</span>

    <span style="color: #F92672;">public</span> <span style="color: #F92672;">static</span> <span style="color: #66D9EF;">void</span> <span style="color: #A6E22E;">main</span><span style="color: #66D9EF;">(</span><span style="color: #66D9EF;">String</span><span style="color: #A6E22E;">[]</span> <span style="color: #FD971F;">args</span><span style="color: #66D9EF;">){</span>
        plus<span style="color: #A6E22E;">(</span>1, 2, result -&gt; System.out.println<span style="color: #E6DB74;">(</span>result<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span>;
    <span style="color: #66D9EF;">}</span>
<span style="color: #AE81FF;">}</span>

</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org8cc7dd7" class="outline-2">
<h2 id="org8cc7dd7">王垠的「40 行代码」</h2>
<div class="outline-text-2" id="text-org8cc7dd7">
<div class="org-src-container">
<pre class="src src-scheme"><span class="linenr"> 1: </span>  <span style="color: #75715E;">;;</span><span style="color: #75715E;">&#160;A&#160;simple&#160;CPS&#160;transformer&#160;which&#160;does&#160;proper&#160;tail-call&#160;and&#160;does&#160;not;;&#160;duplicate&#160;contexts&#160;for&#160;if-expressions.;;&#160;author:&#160;Yin&#160;Wang&#160;(yw21@cs.indiana.edu)(load&#160;"pmatch.scm")(define&#160;cps</span>
<span class="linenr"> 2: </span>&#160;&#160;<span style="color: #AE81FF;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #66D9EF;">(</span>exp<span style="color: #66D9EF;">)</span>
<span class="linenr"> 3: </span>&#160;&#160;&#160;&#160;<span style="color: #66D9EF;">(</span><span style="color: #F92672;">letrec</span>
<span class="linenr"> 4: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #A6E22E;">(</span><span style="color: #E6DB74;">[</span>trivial?&#160;<span style="color: #FD971F;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #F92672;">(</span>x<span style="color: #F92672;">)</span>&#160;<span style="color: #F92672;">(</span>memq&#160;x&#160;'<span style="color: #AE81FF;">(</span>zero?&#160;add1&#160;sub1<span style="color: #AE81FF;">)</span><span style="color: #F92672;">)</span><span style="color: #FD971F;">)</span><span style="color: #E6DB74;">]</span>
<span class="linenr"> 5: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #E6DB74;">[</span>id&#160;<span style="color: #FD971F;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #F92672;">(</span>v<span style="color: #F92672;">)</span>&#160;v<span style="color: #FD971F;">)</span><span style="color: #E6DB74;">]</span>
<span class="linenr"> 6: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #E6DB74;">[</span>ctx0&#160;<span style="color: #FD971F;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #F92672;">(</span>v<span style="color: #F92672;">)</span>&#160;`<span style="color: #F92672;">(</span>k&#160;,v<span style="color: #F92672;">)</span><span style="color: #FD971F;">)</span><span style="color: #E6DB74;">]</span>&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #75715E;">;</span><span style="color: #75715E;">&#160;tail&#160;context</span>
<span class="linenr"> 7: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #E6DB74;">[</span>fv&#160;<span style="color: #FD971F;">(</span><span style="color: #F92672;">let</span>&#160;<span style="color: #F92672;">(</span><span style="color: #AE81FF;">[</span>n&#160;-1<span style="color: #AE81FF;">]</span><span style="color: #F92672;">)</span>
<span class="linenr"> 8: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #F92672;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #AE81FF;">()</span>
<span class="linenr"> 9: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">(</span>set!&#160;n&#160;<span style="color: #66D9EF;">(</span>+&#160;1&#160;n<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span>
<span class="linenr">10: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">(</span>string-&gt;symbol&#160;<span style="color: #66D9EF;">(</span>string-append&#160;<span style="color: #E6DB74;">"v"</span>&#160;<span style="color: #A6E22E;">(</span>number-&gt;string&#160;n<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span><span style="color: #F92672;">)</span><span style="color: #FD971F;">)</span><span style="color: #E6DB74;">]</span>
<span class="linenr">11: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #E6DB74;">[</span>cps1
<span class="linenr">12: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #FD971F;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #F92672;">(</span>exp&#160;ctx<span style="color: #F92672;">)</span>
<span class="linenr">13: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #F92672;">(</span>pmatch&#160;exp
<span class="linenr">14: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">[</span>,x&#160;<span style="color: #66D9EF;">(</span><span style="color: #F92672;">guard</span>&#160;<span style="color: #A6E22E;">(</span>not&#160;<span style="color: #AE81FF;">(</span>pair?&#160;x<span style="color: #AE81FF;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span>&#160;<span style="color: #66D9EF;">(</span>ctx&#160;x<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]</span>
<span class="linenr">15: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span><span style="color: #F92672;">if</span>&#160;,test&#160;,conseq&#160;,alt<span style="color: #66D9EF;">)</span>
<span class="linenr">16: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #66D9EF;">(</span>cps1&#160;test
<span class="linenr">17: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #A6E22E;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #AE81FF;">(</span>t<span style="color: #AE81FF;">)</span>
<span class="linenr">18: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">(</span><span style="color: #F92672;">cond</span>
<span class="linenr">19: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #66D9EF;">[</span><span style="color: #A6E22E;">(</span>memq&#160;ctx&#160;<span style="color: #E6DB74;">(</span>list&#160;ctx0&#160;id<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span>
<span class="linenr">20: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;`<span style="color: #A6E22E;">(</span><span style="color: #F92672;">if</span>&#160;,t&#160;,<span style="color: #E6DB74;">(</span>cps1&#160;conseq&#160;ctx<span style="color: #E6DB74;">)</span>&#160;,<span style="color: #E6DB74;">(</span>cps1&#160;alt&#160;ctx<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">]</span>
<span class="linenr">21: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #66D9EF;">[</span>else
<span class="linenr">22: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #A6E22E;">(</span><span style="color: #F92672;">let</span>&#160;<span style="color: #E6DB74;">(</span><span style="color: #FD971F;">[</span>u&#160;<span style="color: #F92672;">(</span>fv<span style="color: #F92672;">)</span><span style="color: #FD971F;">]</span><span style="color: #E6DB74;">)</span>
<span class="linenr">23: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;`<span style="color: #E6DB74;">(</span><span style="color: #F92672;">let</span>&#160;<span style="color: #FD971F;">(</span><span style="color: #F92672;">[</span>k&#160;<span style="color: #AE81FF;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #66D9EF;">(</span>,u<span style="color: #66D9EF;">)</span>&#160;,<span style="color: #66D9EF;">(</span>ctx&#160;u<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span><span style="color: #F92672;">]</span><span style="color: #FD971F;">)</span>
<span class="linenr">24: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #FD971F;">(</span><span style="color: #F92672;">if</span>&#160;,t&#160;,<span style="color: #F92672;">(</span>cps1&#160;conseq&#160;ctx0<span style="color: #F92672;">)</span>&#160;,<span style="color: #F92672;">(</span>cps1&#160;alt&#160;ctx0<span style="color: #F92672;">)</span><span style="color: #FD971F;">)</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">]</span><span style="color: #AE81FF;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]</span>
<span class="linenr">25: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #A6E22E;">(</span>,x<span style="color: #A6E22E;">)</span>&#160;,body<span style="color: #66D9EF;">)</span>
<span class="linenr">26: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #66D9EF;">(</span>ctx&#160;`<span style="color: #A6E22E;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #AE81FF;">(</span>,x&#160;k<span style="color: #AE81FF;">)</span>&#160;,<span style="color: #AE81FF;">(</span>cps1&#160;body&#160;ctx0<span style="color: #AE81FF;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]</span>
<span class="linenr">27: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span>,op&#160;,a&#160;,b<span style="color: #66D9EF;">)</span>
<span class="linenr">28: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #66D9EF;">(</span>cps1&#160;a&#160;<span style="color: #A6E22E;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #AE81FF;">(</span>v1<span style="color: #AE81FF;">)</span>
<span class="linenr">29: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">(</span>cps1&#160;b&#160;<span style="color: #66D9EF;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #A6E22E;">(</span>v2<span style="color: #A6E22E;">)</span>
<span class="linenr">30: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #A6E22E;">(</span>ctx&#160;`<span style="color: #E6DB74;">(</span>,op&#160;,v1&#160;,v2<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]</span>
<span class="linenr">31: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">[</span><span style="color: #66D9EF;">(</span>,rator&#160;,rand<span style="color: #66D9EF;">)</span>
<span class="linenr">32: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #66D9EF;">(</span>cps1&#160;rator
<span class="linenr">33: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #A6E22E;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #AE81FF;">(</span>r<span style="color: #AE81FF;">)</span>
<span class="linenr">34: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #AE81FF;">(</span>cps1&#160;rand
<span class="linenr">35: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #66D9EF;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #A6E22E;">(</span>d<span style="color: #A6E22E;">)</span>
<span class="linenr">36: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #A6E22E;">(</span><span style="color: #F92672;">cond</span>
<span class="linenr">37: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #E6DB74;">[</span><span style="color: #FD971F;">(</span>trivial?&#160;r<span style="color: #FD971F;">)</span>&#160;<span style="color: #FD971F;">(</span>ctx&#160;`<span style="color: #F92672;">(</span>,r&#160;,d<span style="color: #F92672;">)</span><span style="color: #FD971F;">)</span><span style="color: #E6DB74;">]</span>
<span class="linenr">38: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #E6DB74;">[</span><span style="color: #FD971F;">(</span>eq?&#160;ctx&#160;ctx0<span style="color: #FD971F;">)</span>&#160;`<span style="color: #FD971F;">(</span>,r&#160;,d&#160;k<span style="color: #FD971F;">)</span><span style="color: #E6DB74;">]</span>&#160;&#160;<span style="color: #75715E;">;</span><span style="color: #75715E;">&#160;tail&#160;call</span>
<span class="linenr">39: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #E6DB74;">[</span>else
<span class="linenr">40: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #FD971F;">(</span><span style="color: #F92672;">let</span>&#160;<span style="color: #F92672;">(</span><span style="color: #AE81FF;">[</span>u&#160;<span style="color: #66D9EF;">(</span>fv<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]</span><span style="color: #F92672;">)</span>
<span class="linenr">41: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;`<span style="color: #F92672;">(</span>,r&#160;,d&#160;<span style="color: #AE81FF;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #66D9EF;">(</span>,u<span style="color: #66D9EF;">)</span>&#160;,<span style="color: #66D9EF;">(</span>ctx&#160;u<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span><span style="color: #F92672;">)</span><span style="color: #FD971F;">)</span><span style="color: #E6DB74;">]</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">]</span><span style="color: #F92672;">)</span><span style="color: #FD971F;">)</span><span style="color: #E6DB74;">]</span><span style="color: #A6E22E;">)</span>
<span class="linenr">42: </span>&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #A6E22E;">(</span>cps1&#160;exp&#160;id<span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span><span style="color: #F8F8F2; background-color: #272822;">)</span><span style="color: #75715E;">;;;</span><span style="color: #75715E;">&#160;tests;;&#160;var(cps&#160;'x)(cps&#160;'(lambda&#160;(x)&#160;x))(cps&#160;'(lambda&#160;(x)&#160;(x&#160;1)));;&#160;no&#160;lambda&#160;(will&#160;generate&#160;identity&#160;functions&#160;to&#160;return&#160;to&#160;the&#160;toplevel)(cps&#160;'(if&#160;(f&#160;x)&#160;a&#160;b))(cps&#160;'(if&#160;x&#160;(f&#160;a)&#160;b));;&#160;if&#160;stand-alone&#160;(tail)(cps&#160;'(lambda&#160;(x)&#160;(if&#160;(f&#160;x)&#160;a&#160;b)));;&#160;if&#160;inside&#160;if-test&#160;(non-tail)(cps&#160;'(lambda&#160;(x)&#160;(if&#160;(if&#160;x&#160;(f&#160;a)&#160;b)&#160;c&#160;d)));;&#160;both&#160;branches&#160;are&#160;trivial,&#160;should&#160;do&#160;some&#160;more&#160;optimizations(cps&#160;'(lambda&#160;(x)&#160;(if&#160;(if&#160;x&#160;(zero?&#160;a)&#160;b)&#160;c&#160;d)));;&#160;if&#160;inside&#160;if-branch&#160;(tail)(cps&#160;'(lambda&#160;(x)&#160;(if&#160;t&#160;(if&#160;x&#160;(f&#160;a)&#160;b)&#160;c)));;&#160;if&#160;inside&#160;if-branch,&#160;but&#160;again&#160;inside&#160;another&#160;if-test&#160;(non-tail)(cps&#160;'(lambda&#160;(x)&#160;(if&#160;(if&#160;t&#160;(if&#160;x&#160;(f&#160;a)&#160;b)&#160;c)&#160;e&#160;w)));;&#160;if&#160;as&#160;operand&#160;(non-tail)(cps&#160;'(lambda&#160;(x)&#160;(h&#160;(if&#160;x&#160;(f&#160;a)&#160;b))));;&#160;if&#160;as&#160;operator&#160;(non-tail)(cps&#160;'(lambda&#160;(x)&#160;((if&#160;x&#160;(f&#160;g)&#160;h)&#160;c)));;&#160;why&#160;we&#160;need&#160;more&#160;than&#160;two&#160;names(cps&#160;'(((f&#160;a)&#160;(g&#160;b))&#160;((f&#160;c)&#160;(g&#160;d))));;&#160;factorial(define&#160;fact-cps</span>
<span class="linenr">43: </span>&#160;&#160;<span style="color: #F8F8F2; background-color: #272822;">(</span>cps
<span class="linenr">44: </span>&#160;&#160;&#160;'<span style="color: #AE81FF;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #66D9EF;">(</span>n<span style="color: #66D9EF;">)</span>
<span class="linenr">45: </span>&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #66D9EF;">(</span><span style="color: #A6E22E;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #E6DB74;">(</span>fact<span style="color: #E6DB74;">)</span>
<span class="linenr">46: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #E6DB74;">(</span><span style="color: #FD971F;">(</span>fact&#160;fact<span style="color: #FD971F;">)</span>&#160;n<span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span>
<span class="linenr">47: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #A6E22E;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #E6DB74;">(</span>fact<span style="color: #E6DB74;">)</span>
<span class="linenr">48: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #E6DB74;">(</span><span style="color: #F92672;">lambda</span>&#160;<span style="color: #FD971F;">(</span>n<span style="color: #FD971F;">)</span>
<span class="linenr">49: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #FD971F;">(</span><span style="color: #F92672;">if</span>&#160;<span style="color: #F92672;">(</span>zero?&#160;n<span style="color: #F92672;">)</span>
<span class="linenr">50: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1
<span class="linenr">51: </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #F92672;">(</span>*&#160;n&#160;<span style="color: #AE81FF;">(</span><span style="color: #66D9EF;">(</span>fact&#160;fact<span style="color: #66D9EF;">)</span>&#160;<span style="color: #66D9EF;">(</span>sub1&#160;n<span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span><span style="color: #F92672;">)</span><span style="color: #FD971F;">)</span><span style="color: #E6DB74;">)</span><span style="color: #A6E22E;">)</span><span style="color: #66D9EF;">)</span><span style="color: #AE81FF;">)</span><span style="color: #F8F8F2; background-color: #272822;">))</span><span style="color: #75715E;">;;</span><span style="color: #75715E;">&#160;print&#160;out&#160;CPSed&#160;function(pretty-print&#160;fact-cps);;&#160;=&gt;;;&#160;'(lambda&#160;(n&#160;k);;&#160;&#160;&#160;&#160;((lambda&#160;(fact&#160;k)&#160;(fact&#160;fact&#160;(lambda&#160;(v0)&#160;(v0&#160;n&#160;k))));;&#160;&#160;&#160;&#160;&#160;(lambda&#160;(fact&#160;k);;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(k;;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(lambda&#160;(n&#160;k);;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(if&#160;(zero?&#160;n);;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(k&#160;1);;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(fact;;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;fact;;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(lambda&#160;(v1)&#160;(v1&#160;(sub1&#160;n)&#160;(lambda&#160;(v2)&#160;(k&#160;(*&#160;n&#160;v2))))))))));;&#160;&#160;&#160;&#160;&#160;k))((eval&#160;fact-cps)&#160;5&#160;(lambda&#160;(v)&#160;v));;&#160;=&gt;&#160;120</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-orgef3a38d" class="outline-2">
<h2 id="orgef3a38d">参考资料</h2>
<div class="outline-text-2" id="text-orgef3a38d">
<ul class="org-ul">
<li><a href="https://blog.csdn.net/yilu_beiyu/article/details/122536957">CPS</a></li>
<li><a href="https://www.zhihu.com/question/20822815">王垠的[40行代码]真如他说的那么厉害吗？</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-06-21 Tue 14:58</p>
</div>
</body>
</html>
